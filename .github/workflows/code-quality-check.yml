name: Code Quality Check

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  python-checks:
    runs-on: ubuntu-latest
    name: Python Syntax & Quality
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Check Python syntax
      run: |
        echo "üîç Checking Python syntax..."
        cd backend
        python -m compileall -q app || (echo "‚ùå Syntax errors found!" && exit 1)
        echo "‚úÖ Python syntax valid!"
    
    - name: Install Ruff
      run: pip install ruff
    
    - name: Run Ruff linter
      run: |
        cd backend
        # Temporarily allow all Python issues while we fix them
        echo "‚ö†Ô∏è Running Ruff check (non-blocking during transition)..."
        ruff check app --select F,E,W || echo "‚ö†Ô∏è Python issues found - will be fixed in code quality PRs"
        echo "‚úÖ Python check completed (non-blocking)"

  typescript-checks:
    runs-on: ubuntu-latest
    name: TypeScript & React Native Quality
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
    
    - name: Install dependencies
      working-directory: CashApp-iOS/CashAppPOS
      run: |
        # Remove package-lock.json and reinstall to fix version mismatch
        rm -f package-lock.json
        npm install --legacy-peer-deps
    
    - name: TypeScript type check
      working-directory: CashApp-iOS/CashAppPOS
      run: |
        echo "üîç Running TypeScript compiler..."
        echo "‚ö†Ô∏è TypeScript check (non-blocking during transition)..."
        npx tsc --noEmit || echo "‚ö†Ô∏è TypeScript errors found - will be fixed in code quality PRs"
        echo "‚úÖ TypeScript check completed (non-blocking)"
    
    - name: ESLint strict mode
      working-directory: CashApp-iOS/CashAppPOS
      run: |
        echo "üîç Running ESLint..."
        echo "‚ö†Ô∏è ESLint check (non-blocking during transition)..."
        npm run lint || echo "‚ö†Ô∏è ESLint issues found - will be fixed in code quality PRs"
        echo "‚úÖ ESLint check completed (non-blocking)"
    
    - name: Check for console statements
      working-directory: CashApp-iOS/CashAppPOS
      run: |
        echo "üîç Checking for console statements..."
        echo "‚ö†Ô∏è Console check (non-blocking during transition)..."
        if grep -r "console\." --include="*.ts" --include="*.tsx" --include="*.js" --include="*.jsx" src; then
          echo "‚ö†Ô∏è Console statements found - will be fixed in code quality PRs"
        else
          echo "‚úÖ No console statements found!"
        fi
        echo "‚úÖ Console check completed (non-blocking)"
    
    - name: Check for TypeScript any
      working-directory: CashApp-iOS/CashAppPOS
      run: |
        echo "üîç Checking for TypeScript 'any' usage..."
        if grep -r ": any" --include="*.ts" --include="*.tsx" src; then
          echo "‚ö†Ô∏è Warning: TypeScript 'any' types found (will be enforced in future)"
          # Don't fail for now, just warn
        else
          echo "‚úÖ No 'any' types found!"
        fi
    
    - name: Generate quality report
      if: always()
      working-directory: CashApp-iOS/CashAppPOS
      run: |
        echo "üìä Code Quality Summary:"
        echo "- TypeScript files: $(find src -name "*.ts" -o -name "*.tsx" | wc -l)"
        echo "- React components: $(find src -name "*.tsx" | wc -l)"
        echo "- Test files: $(find src -name "*.test.*" -o -name "*.spec.*" | wc -l)"