name: Code Quality Check

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  python-checks:
    runs-on: ubuntu-latest
    name: Python Syntax & Quality
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Check Python syntax
      run: |
        echo "üîç Checking Python syntax..."
        cd backend
        python -m compileall -q app || (echo "‚ùå Syntax errors found!" && exit 1)
        echo "‚úÖ Python syntax valid!"
    
    - name: Install Ruff
      run: pip install ruff
    
    - name: Run Ruff linter
      run: |
        cd backend
        # Run Ruff but only fail on F (fatal errors), not E/W (style warnings)
        ruff check app --select F --exit-non-zero-on-fix || exit 1
        # Run E/W checks but don't fail the build (yet)
        ruff check app --select E,W || echo "‚ö†Ô∏è Style warnings found (not blocking)"
        echo "‚úÖ Ruff fatal error checks passed!"

  typescript-checks:
    runs-on: ubuntu-latest
    name: TypeScript & React Native Quality
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: CashApp-iOS/CashAppPOS/package-lock.json
    
    - name: Install dependencies
      working-directory: CashApp-iOS/CashAppPOS
      run: npm ci --legacy-peer-deps
    
    - name: TypeScript type check
      working-directory: CashApp-iOS/CashAppPOS
      run: |
        echo "üîç Running TypeScript compiler..."
        npx tsc --noEmit || (echo "‚ùå TypeScript errors found!" && exit 1)
        echo "‚úÖ TypeScript compilation passed!"
    
    - name: ESLint strict mode
      working-directory: CashApp-iOS/CashAppPOS
      run: |
        echo "üîç Running ESLint in strict mode..."
        npm run lint -- --max-warnings=0 || (echo "‚ùå ESLint warnings/errors found!" && exit 1)
        echo "‚úÖ ESLint checks passed!"
    
    - name: Check for console statements
      working-directory: CashApp-iOS/CashAppPOS
      run: |
        echo "üîç Checking for console statements..."
        if grep -r "console\." --include="*.ts" --include="*.tsx" --include="*.js" --include="*.jsx" src; then
          echo "‚ùå Console statements found in production code!"
          exit 1
        fi
        echo "‚úÖ No console statements found!"
    
    - name: Check for TypeScript any
      working-directory: CashApp-iOS/CashAppPOS
      run: |
        echo "üîç Checking for TypeScript 'any' usage..."
        if grep -r ": any" --include="*.ts" --include="*.tsx" src; then
          echo "‚ö†Ô∏è Warning: TypeScript 'any' types found (will be enforced in future)"
          # Don't fail for now, just warn
        else
          echo "‚úÖ No 'any' types found!"
        fi
    
    - name: Generate quality report
      if: always()
      working-directory: CashApp-iOS/CashAppPOS
      run: |
        echo "üìä Code Quality Summary:"
        echo "- TypeScript files: $(find src -name "*.ts" -o -name "*.tsx" | wc -l)"
        echo "- React components: $(find src -name "*.tsx" | wc -l)"
        echo "- Test files: $(find src -name "*.test.*" -o -name "*.spec.*" | wc -l)"